/*
*	(C)2009-2014 VeryIDE
*	http://www.veryide.com/
*	Scene 图片预览工具
*	$Id: scene.js 2014/06/13 Lay $
*/
var Scene={pack:null,size:10,list:null,task:null,point:{},child:{},$:function(obj){return document.getElementById(obj)},time:function(){return new Date().getTime()},addEvent:function(obj,type,fn,cap){var cap=cap||false;if(obj.addEventListener){obj.addEventListener(type,fn,cap)}else{obj.attachEvent("on"+type,fn)}},removeEvent:function(obj,type,fn,cap){var cap=cap||false;if(obj.removeEventListener){obj.removeEventListener(type,fn,cap)}else{obj.detachEvent("on"+type,fn)}},getBody:function(){return{width:document.body.clientWidth,height:document.body.clientHeight}},getChild:function(selector){if(selector.indexOf(".")==0){return Scene.pack.getElementsByClassName(selector.substring(1))[0]}else{return Scene.pack.getElementsByTagName(selector)[0]}},init:function(context){Scene.pack=document.createElement("div");Scene.pack.id="scene";Scene.pack.innerHTML=""+'<div class="control">'+'<string class="zoom"></string>'+'<string class="exit">x</string>'+"</div>"+'<div class="handle">'+'<string class="page"></string>'+'<strong class="prev">&#139;</strong>'+'<strong class="next">&#155;</strong>'+"</div>"+'<div class="background">'+'<div class="frame"><img /></div>'+"</div>";document.body.appendChild(Scene.pack);Scene.child.place=Scene.getChild("img");Scene.child.zoom=Scene.getChild(".zoom");Scene.child.page=Scene.getChild(".page");Scene.child.exit=Scene.getChild(".exit");var root=context||document;Scene.list=root.getElementsByTagName("img");for(var i=0;i<Scene.list.length;i++){var self=Scene.list[i];self.setAttribute("data-index",i);self.onclick=(function(file){return function(e){Scene.show(this,e)}})(self)}if(Scene.list.length>1){var handle=Scene.getChild(".handle");Scene.addEvent(Scene.pack,"mouseover",function(e){handle.style.visibility="visible"},false);Scene.addEvent(Scene.pack,"mouseout",function(e){handle.style.visibility="hidden"},false);var prev=Scene.getChild(".prev");Scene.addEvent(prev,"click",function(e){if(Scene.task==0){Scene.page(Scene.list.length-1,e)}else{Scene.page(Scene.task-1,e)}},false);var next=Scene.getChild(".next");Scene.addEvent(next,"click",function(e){if(Scene.task+1>Scene.list.length-1){Scene.page(0,e)}else{Scene.page(Scene.task+1,e)}},false)}Scene.addEvent(Scene.pack,"click",function(e){Scene.exit(this,e)},false);Scene.addEvent(Scene.child.place,"click",function(e){if(Scene.list.length<=1){return}if(Scene.task+1>Scene.list.length-1){Scene.page(0,e)}else{Scene.page(Scene.task+1,e)}},false);Scene.addEvent(Scene.child.exit,"click",function(e){Scene.exit(this,e)},false);Scene.addEvent(window,"resize",function(e){if(Scene.pack.className!="show"){return}Scene.zoom(e)},false);Scene.addEvent(document.body,"mousewheel",function(e){if(Scene.pack.className!="show"){return}if(e.wheelDelta>=120){Scene.size++}else{if(e.wheelDelta<=-120&&Scene.size>1){Scene.size--}}Scene.zoom(e)},false)},page:function(index,e){Scene.init&&window.clearTimeout(Scene.init);if(index>=0&&index<=Scene.list.length-1){Scene.show(Scene.list[index],e);Scene.child.page.innerHTML=(index+1)+"/"+Scene.list.length;Scene.child.page.style.visibility="visible";Scene.size=10;Scene.zoom(e);Scene.init=window.setTimeout(function(){Scene.child.page.style.visibility="hidden"},2000)}},show:function(image,e){Scene.pack.className="show";Scene.task=parseInt(image.getAttribute("data-index"));Scene.child.image=image;Scene.child.place.src=image.src;Scene.align("natural")},zoom:function(e){e.preventDefault();var image=Scene.child.image;var place=Scene.child.place;Scene.child.zoom.style.visibility="visible";Scene.init&&window.clearTimeout(Scene.init);Scene.child.zoom.innerHTML=Scene.size+"0%";Scene.align("offset");if(Scene.size>=20){Scene.child.exit.style.visibility="visible"}else{Scene.child.exit.style.visibility="hidden"}Scene.init=window.setTimeout(function(){Scene.child.zoom.style.visibility="hidden"},2000)},align:function(type){var port=Scene.getBody();var image=Scene.child.image;var place=Scene.child.place;switch(type){case"natural":var size={width:image.naturalWidth,height:image.naturalHeight};var scale=size.width/size.height;if(size.width>port.width){size.width=port.width*0.9;size.height=size.width/scale}if(size.height>port.height){size.height=port.height*0.9;size.width=size.height*scale}break;case"offset":var size={width:image.width*Scene.size/10,height:image.height*Scene.size/10};break}size.x=port.width-size.width;size.y=port.height-size.height;place.style.width=size.width+"px";place.style.height=size.height+"px";Scene.child.frame=Scene.getChild(".frame");Scene.child.frame.style.top=(size.y/2)+"px";Scene.child.frame.style.left=(size.x/2)+"px"},exit:function(pack,e){e.preventDefault();if(e.target&&/(background|exit)/.test(e.target.className)){Scene.pack.className="hide";Scene.size=10}}};